name: ðŸ” Auto Update Sony Playlist

on:
  schedule:
    - cron: "*/2 * * * *"  # Every 2 minutes
  workflow_dispatch:

jobs:
  update-playlist:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ§° Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ðŸ“¦ Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install requests

      - name: ðŸ“¥ Fetch and Generate JSON
        env:
          PLAYLIST_URL: ${{ secrets.URL }}
        run: |
          cat > fetch_script.py <<'PYCODE'
          import requests, json, re, os

          url = os.getenv("PLAYLIST_URL")
          print(f"ðŸ“¡ Fetching playlist from: {url}")

          try:
              r = requests.get(url)
              r.raise_for_status()
          except Exception as e:
              print(f"âŒ Failed to fetch playlist: {e}")
              exit(1)

          content = r.text.strip().splitlines()
          channels = []
          current = {}

          for line in content:
              if line.startswith('#EXTINF:'):
                  match = re.search(r'tvg-id="([^"]*)" tvg-name="([^"]*)" tvg-logo="([^"]*)" tvg-language="([^"]*)" group-title="([^"]*)",(.*)', line)
                  if match:
                      current = {
                          "id": match.group(1),
                          "name": match.group(2),
                          "logo": match.group(3),
                          "language": match.group(4),
                          "category": match.group(5),
                          "title": match.group(6).strip()
                      }
              elif line.startswith('http'):
                  if '|User-Agent=' in line:
                      url, ua = line.split('|User-Agent=')
                      current["url"] = url.strip()
                      current["user_agent"] = ua.strip()
                  else:
                      current["url"] = line.strip()
                      current["user_agent"] = "Unknown"
                  channels.append(current)
                  current = {}

          data = {
              "api_made_by": "bd coder boy",
              "updated": r.headers.get("Date", "Unknown"),
              "channels": channels
          }

          with open("api.json", "w") as f:
              json.dump(data, f, indent=2)

          playlist = [{"id": c["id"], "name": c["title"], "url": c["url"]} for c in channels]
          with open("playlist.json", "w") as f:
              json.dump(playlist, f, indent=2)

          print(f"âœ… Generated api.json and playlist.json ({len(channels)} channels)")
          PYCODE

          python3 fetch_script.py

      - name: ðŸ’¾ Commit and Push Changes
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions Bot"
          git add api.json playlist.json
          git diff --cached --quiet || git commit -m "Auto update Sony playlist $(date)"
          git push
